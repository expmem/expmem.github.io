<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ruedas de Reconocimiento</title>
  <style>
    /* Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* General */
    body, html {
      height: 100%;
      font-family: 'Roboto', Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Full-screen containers */
    .full-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      padding: 20px;
      text-align: center;
    }

    .hidden { display: none; }

    /* Grid for photos */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      max-width: 600px;
      width: 90%;
    }

    .photo {
      width: 100%;
      cursor: pointer;
      transition: transform 0.3s;
      border-radius: 5px;
    }
    .photo:hover {
      transform: scale(1.05);
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      display: none;
    }

    .modal-content {
      background: #fff;
      padding: 20px;
      text-align: center;
      border-radius: 8px;
      max-width: 90%;
      width: 300px;
    }

    /* Buttons */
    button {
      background-color: #673ab7;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
      margin: 5px;
    }

    button:hover {
      background-color: #5e35b1;
    }

    .text-container {
      max-width: 600px;
      width: 100%;
      background-color: #fff;
      border: 1px solid #dadce0;
      border-top: 8px solid #673ab7;
      border-radius: 8px;
      box-shadow: 0px 3px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
      box-sizing: border-box;
    }

    .confirm-button { background-color: #4CAF50; }
    .confirm-button:hover { background-color: #45a049; }
    .cancel-button { background-color: #f44336; }
    .cancel-button:hover { background-color: #da190b; }

    input[type="text"], input[type="number"], input[type="time"] {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      width: 200px;
    }

    .loading {
      display: none;
      margin-top: 20px;
      color: #673ab7;
      font-weight: bold;
    }
  </style>
</head>
<body>

<!-- Comienza directamente con las instrucciones -->
<div class="full-screen" id="instructionsStart">
  <h2>Instrucciones</h2>
  <br>
  <div class="text-container">
    <p>Ahora vas a realizar una rueda de reconocimiento con seis sospechosos, entre los que se puede encontrar una de las personas que robó la pizzería en el video que viste. Tomate tu tiempo para verlos.<br>
      Si identificas a uno de los ladrones entre los sospechosos seleccioná su foto. Si no reconoces a ninguno utiliza el boton "no reconozco a ninguno" que esta abajo de las fotos.</p>
  </div>
  <br>
  <button onclick="showLineup()">Comenzar</button>
</div>

<div class="full-screen hidden" id="lineupContainer">
  <h2>¿Reconoces a alguno de los ladrones?</h2>
  <br>
  <div class="photo-grid" id="photoGrid">
    <!-- Photos will be dynamically added here -->
  </div>
  <br>
  <button id="opcionCero">No reconozco a ninguno</button>
</div>

<div class="modal" id="confirmationModal">
  <div class="modal-content">
    <p>¿Confirmar elección?</p>
    <img src="" alt="Selected" id="selectedPhoto" style="width:100px; border-radius:5px;">
    <br><br>
    <button class="confirm-button" id="confirmButton">Confirmar</button>
    <button class="cancel-button" id="cancelButton">Cancelar</button>
  </div>
</div>

<div id="confidence" class="full-screen hidden">
  <p>Del 0 al 100 ¿Qué confianza tenes en tu elección?</p>
  <br>
  <input type="number" id="confidenceInput" min="0" max="100" placeholder="Confianza (0-100)" required>
  <br><br>
  <button class="confirm-button" id="nextButton">Seguir</button>
</div>

<div class="full-screen hidden" id="instructionsQuestions">
  <h2>Cuestionario</h2>
  <br>
  <div class="text-container">
    <p>En la siguiente tarea vas a responder una serie de preguntas referidas al video, utilizando uno de los tres botones debajo de cada pregunta.</p>
  </div>
  <br>
  <button onclick="startQuestions()">Comenzar</button>
</div>

<div class="full-screen hidden" id="questionContainer">
  <h2>Preguntas</h2>
  <br>
  <div id="questionContent">
    <!-- Questions will be displayed here -->
  </div>
</div>

<div class="full-screen hidden" id="thankYouScreen">
  <h2>¡Gracias por participar!</h2>
  <br>
  <div class="text-container">
    <p>Tu participación ha sido muy valiosa para nuestro estudio.</p>
    <p class="loading" id="loadingMessage">Enviando respuestas...</p>
  </div>
</div>

<!-- Formulario principal -->
<form id="googleForm" action="https://docs.google.com/forms/d/e/1FAIpQLSc6GToABx5tQTPC_5XS03qoUTYwaIjF0gM5I_zxRIM3TDtJsg/formResponse" target="formTarget" method="POST">
  <input type="hidden" name="entry.1706121057" id="entry.1706121057">
  <input type="hidden" name="entry.1795197407" id="entry_1795197407">
  <input type="hidden" name="entry.1108713682" id="entry_1108713682">

  <input type="hidden" name="entry.1976955927" id="entry_1976955927">
  <input type="hidden" name="entry.1006823805" id="entry_1006823805">
  <input type="hidden" name="entry.114523550" id="entry_114523550">
  <input type="hidden" name="entry.1993344215" id="entry_1993344215">

  <input type="hidden" name="entry.1220245853" id="entry_1220245853">
  <input type="hidden" name="entry.1511974812" id="entry_1511974812">
  <input type="hidden" name="entry.591454687" id="entry_591454687">
  <input type="hidden" name="entry.1654474234" id="entry_1654474234">
  <input type="hidden" name="entry.1724594370" id="entry_1724594370">
  <input type="hidden" name="entry.765485932" id="entry_765485932">
  <input type="hidden" name="entry.2054724147" id="entry_2054724147">
  <input type="hidden" name="entry.540105700" id="entry_540105700">
  <input type="hidden" name="entry.1879992819" id="entry_1879992819">
  <input type="hidden" name="entry.545488488" id="entry_545488488">
  <input type="hidden" name="entry.1138152553" id="entry_1138152553">
  <input type="hidden" name="entry.2101045136" id="entry_2101045136">
  <input type="hidden" name="entry.973497637" id="entry_973497637">
  <input type="hidden" name="entry.1051167862" id="entry_1051167862">
  <input type="hidden" name="entry.1619698537" id="entry_1619698537">
  <input type="hidden" name="entry.2100816218" id="entry_2100816218">
  <input type="hidden" name="entry.120025552" id="entry_120025552">
  <input type="hidden" name="entry.1035456947" id="entry_1035456947"> 
</form>

<iframe name="formTarget" style="display:none;"></iframe>

<script>
// Variables para almacenar respuestas
let userId = "";
let userDevice = "Computadora";
let userLineupSelections = [];
let userConfidenceLevels = [];
let firstSetAnswers = [];

// Simulated photos for each lineup
const lineups = [
  ["1.jpg", "2.jpg", "3.jpg", "4.jpg", "5.jpg", "6.jpg"],
  ["7.jpg", "8.jpg", "9.jpg", "10.jpg", "11.jpg", "12.jpg"]
];

// Questions for the first questionnaire
const questions = [
  "¿Los ladrones dieron la orden de levantar las manos?", 
  "¿Los ladrones llegaron en auto?", 
  "¿Un cliente tenía anteojos?", 
  "¿Los ladrones golpearon al cajero?", 
  "¿La camarera lloró durante el robo?", 
  "¿Había un ladrón con barba?", 
  "¿Un ladrón llevaba campera verde?", 
  "¿Los ladrones entraron juntos al local?", 
  "¿Había dos ladrones?", 
  "¿Le pegaron un culatazo a un cliente?", 
  "¿Un cliente llevaba camisa?", 
  "¿Se robaron la computadora del cajero?", 
  "¿Había seis clientes?", 
  "¿Un ladrón tenia tatuajes en la cara?", 
  "¿Los ladrones amenazaron al espectador?", 
  "¿Los ladrones llevaban mochilas?", 
  "¿Una clienta llevaba suéter naranja?", 
  "¿Los ladrones empujaron una mesa para sacarla del camino?"
];

let currentLineup = 0;
let currentQuestion = 0;
let group = "";

// UI Elements
const instructionsStart = document.getElementById("instructionsStart");
const lineupContainer = document.getElementById("lineupContainer");
const questionContainer = document.getElementById("questionContainer");
const photoGrid = document.getElementById("photoGrid");
const confirmationModal = document.getElementById("confirmationModal");
const selectedPhoto = document.getElementById("selectedPhoto");
const confirmButton = document.getElementById("confirmButton");
const cancelButton = document.getElementById("cancelButton");
const nextButton = document.getElementById("nextButton");
const instructionsQuestions = document.getElementById("instructionsQuestions");
const questionContent = document.getElementById("questionContent");
const confidenceInput = document.getElementById("confidenceInput");
const confidence = document.getElementById("confidence");
const opcionCero = document.getElementById("opcionCero");
const thankYouScreen = document.getElementById("thankYouScreen");
const loadingMessage = document.getElementById("loadingMessage");

// Function to get URL parameter by name
function getParameterByName(name) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(name);
}

// Function to generate random ID
function generateRandomId() {
  return 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36);
}

// Function to get or create user ID from localStorage
function getOrCreateUserId() {
  let storedUserId = localStorage.getItem('study_user_id');
  
  if (!storedUserId) {
    storedUserId = generateRandomId();
    localStorage.setItem('study_user_id', storedUserId);
    console.log("Nuevo ID de usuario generado:", storedUserId);
  } else {
    console.log("ID de usuario recuperado de localStorage:", storedUserId);
  }
  
  return storedUserId;
}

// Function to handle the group parameter
function handleGroupParameter() {
  group = getParameterByName('group');
  if (group) {
    console.log("User's group:", group);
  }
  
  // Obtener o crear ID de usuario desde localStorage
  userId = getOrCreateUserId();
  console.log("User ID:", userId);
}

// Run this function when the page loads
window.onload = handleGroupParameter;

// Start recognition lineup
function showLineup() {
  instructionsStart.classList.add("hidden");
  lineupContainer.classList.remove("hidden");
  loadLineup();
}

// Load photos for the current lineup
function loadLineup() {
  photoGrid.innerHTML = "";
  lineups[currentLineup].forEach(photo => {
    const img = document.createElement("img");
    img.src = photo;
    img.classList.add("photo");
    img.onclick = () => openConfirmationModal(photo);
    photoGrid.appendChild(img);
  });
  
  // Reasignar el evento para el botón "No reconozco a ninguno"
  opcionCero.onclick = () => openConfirmationModal("0.jpg");
}

// Open confirmation modal
function openConfirmationModal(photo) {
  selectedPhoto.src = photo;
  confirmationModal.style.display = "flex";
}

// Close confirmation modal
function closeConfirmationModal() {
  confirmationModal.style.display = "none";
}

// Confirm selection
confirmButton.onclick = () => {
  closeConfirmationModal();
  lineupContainer.classList.add("hidden");
  confidence.classList.remove("hidden");
  
  // Extraer el número de la foto seleccionada
  const photoMatch = selectedPhoto.src.match(/(\d+)(?=\.jpg$)/);
  if (photoMatch) {
    userLineupSelections.push(photoMatch[0]);
  } else {
    userLineupSelections.push("0"); // Para "No reconozco a ninguno"
  }
};

// Next lineup
nextButton.onclick = () => {
  const confidenceValue = confidenceInput.value;
  if (confidenceValue < 0 || confidenceValue > 100 || confidenceValue === "") {
    alert("Por favor, ingresa un nivel de confianza entre 0 y 100.");
    return;
  }

  userConfidenceLevels.push(confidenceValue);
  console.log("Confidence levels:", userConfidenceLevels);
  
  confidence.classList.add("hidden");
  confidenceInput.value = "";
  currentLineup++;

  if (currentLineup < lineups.length) {
    lineupContainer.classList.remove("hidden");
    loadLineup(); // Load next lineup
  } else {
    lineupContainer.classList.add("hidden");
    instructionsQuestions.classList.remove("hidden");
  }
};

// Cancel selection
cancelButton.onclick = closeConfirmationModal;

// Start first question set after instruction screen
function startQuestions() {
  instructionsQuestions.classList.add("hidden");
  questionContainer.classList.remove("hidden");
  showQuestion();
}

// Show current question in the first set
function showQuestion() {
  if (currentQuestion < questions.length) {
    questionContent.innerHTML = `
      <div class="text-container">
        <p>${questions[currentQuestion]}</p>
      </div>
      <br>
      <button onclick="answerQuestion('SI')">Sí</button>
      <button onclick="answerQuestion('NO')">No</button>
      <button onclick="answerQuestion('NO SE')">No se</button>
    `;
  } else {
    questionContainer.classList.add("hidden");
    asignarRespuestas();
  }
}

// Responder una pregunta en el primer conjunto
function answerQuestion(answer) {
  firstSetAnswers.push(answer);
  currentQuestion++;
  console.log("Answers:", firstSetAnswers);
  showQuestion();
}

// Función para asignar las respuestas dinámicamente
function asignarRespuestas() {
  // Mostrar mensaje de carga
  thankYouScreen.classList.remove("hidden");
  loadingMessage.style.display = "block";
  
  // Asignar las respuestas a los campos ocultos
  document.getElementById('entry.1706121057').value = group || "No especificado";          
  document.getElementById('entry_1795197407').value = userId;
  document.getElementById('entry_1108713682').value = userDevice;

  // Asignar selecciones de rueda de reconocimiento
  document.getElementById('entry_1976955927').value = userLineupSelections[0] || "No seleccionado";
  document.getElementById('entry_1006823805').value = userConfidenceLevels[0] || "0";
  document.getElementById('entry_114523550').value = userLineupSelections[1] || "No seleccionado";
  document.getElementById('entry_1993344215').value = userConfidenceLevels[1] || "0";

  // Asignar respuestas a preguntas
  const entries = [
    'entry_1220245853', 'entry_1511974812', 'entry_591454687', 'entry_1654474234',
    'entry_1724594370', 'entry_765485932', 'entry_2054724147', 'entry_540105700',
    'entry_1879992819', 'entry_545488488', 'entry_1138152553', 'entry_2101045136',
    'entry_973497637', 'entry_1051167862', 'entry_1619698537', 'entry_2100816218',
    'entry_120025552', 'entry_1035456947'
  ];

  for (let i = 0; i < entries.length; i++) {
    document.getElementById(entries[i]).value = firstSetAnswers[i] || "No respondida";
  }

  // Enviar el formulario después de un breve retraso para asegurar que los valores se han establecido
  setTimeout(() => {
    const form = document.getElementById('googleForm');
    
    // Verificar que todos los campos tengan valores
    const allInputs = form.querySelectorAll('input[type="hidden"]');
    let allFilled = true;
    
    allInputs.forEach(input => {
      if (!input.value || input.value === "") {
        console.warn(`Campo vacío: ${input.name}`);
        allFilled = false;
      }
    });
    
    if (allFilled) {
      console.log("Enviando formulario...");
      console.log("Datos a enviar:", {
        group: document.getElementById('entry.1706121057').value,
        userId: document.getElementById('entry_1795197407').value,
        device: document.getElementById('entry_1108713682').value
      });
      
      form.submit();
      
      // Ocultar mensaje de carga después del envío
      setTimeout(() => {
        loadingMessage.style.display = "none";
      }, 2000);
    } else {
      console.error("No se pueden enviar campos vacíos");
      loadingMessage.textContent = "Error al enviar respuestas. Por favor, recarga la página e intenta nuevamente.";
    }
  }, 500);
}
</script>
</body>
</html>
